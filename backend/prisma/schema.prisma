generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String
  email     String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  tenantId  String   @db.Uuid
  Tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Ticket    Ticket[]

  @@unique([tenantId, email])
  @@index([tenantId], map: "idx_customer_tenantId")
}

model NotificationLog {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  message   String
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  tenantId  String   @db.Uuid
  ticketId  String   @db.Uuid
  Tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId], map: "idx_notificationlog_tenantId")
  @@index([ticketId], map: "idx_notificationlog_ticketId")
}

model Tenant {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name            String
  Customer        Customer[]
  NotificationLog NotificationLog[]
  Ticket          Ticket[]
  User            User[]
}

model Ticket {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title           String
  description     String
  status          TicketStatus      @default(OPEN)
  assignedTo      String?
  createdAt       DateTime          @default(now()) @db.Timestamptz(6)
  tenantId        String            @db.Uuid
  customerId      String            @db.Uuid
  NotificationLog NotificationLog[]
  Customer        Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([status], map: "idx_ticket_status")
  @@index([tenantId], map: "idx_ticket_tenantId")
}

model User {
  id       String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email    String     @unique
  password String
  tenantId String     @db.Uuid
  roles    UserRole[] @default([admin])
  Tenant   Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId], map: "idx_user_tenantId")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum UserRole {
  admin
  agent
}
